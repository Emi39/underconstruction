{% extends 'base.html' %}

{% block title %}{{ article.title }} - SoftwareCA{% endblock %}

{% block content %}
    <article style="max-width: 900px; margin: 0 auto; padding: 2rem 1rem;">
        <h1 style="margin-bottom: 0.5rem; color: var(--accent);">{{ article.title }}</h1>
        
        {% if article.category %}
            <p style="margin: 0.5rem 0; color: var(--accent); font-weight: 600;">
                Category: <a href="{% url 'category_detail' slug=article.category.slug %}" style="color: var(--accent); text-decoration: underline;">{{ article.category.name }}</a>
            </p>
        {% endif %}
        
        <div class="meta" style="color: #94a3b8; font-size: 0.95rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
            Published: {{ article.pub_date|date:"d F Y" }} • Last updated: {{ article.updated_at|date:"d F Y" }}
        </div>

        <div class="content" style="font-size: 1.1rem; line-height: 1.8;">
            {{ article.content|safe }}
        </div>

        <!-- Social Sharing Icons -->
        <div style="margin: 3rem 0; text-align: center;">
            <p style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 1.2rem;">Share this article</p>
            
            <div style="display: flex; justify-content: center; gap: 1.2rem; flex-wrap: wrap;">
                <!-- X -->
                <a href="https://twitter.com/intent/tweet?text={{ article.title|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" 
                   target="_blank" rel="noopener noreferrer" title="Share on X"
                   style="display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; background: #000; color: white; border-radius: 50%; transition: transform 0.2s;">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </a>

                <!-- Facebook -->
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}&quote={{ article.title|urlencode }}" 
                   target="_blank" rel="noopener noreferrer" title="Share on Facebook"
                   style="display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; background: #1877f2; color: white; border-radius: 50%; transition: transform 0.2s;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9.197 21.5h3.606v-8.4h2.603l.39-3.02h-2.993V8.05c0-.872.244-1.466 1.492-1.466h1.595V3.9c-.276-.037-.77-.05-1.378-.05-1.365 0-2.3.833-2.3 2.363v2.757h-3.606v3.02h3.606v8.4z"/>
                    </svg>
                </a>

                <!-- LinkedIn -->
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}" 
                   target="_blank" rel="noopener noreferrer" title="Share on LinkedIn"
                   style="display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; background: #0a66c2; color: white; border-radius: 50%; transition: transform 0.2s;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.45 20.45h-3.56v-5.57c0-1.33-.02-3.04-1.85-3.04-1.85 0-2.13 1.45-2.13 2.94v5.67H9.35V9h3.41v1.56h.05c.47-.9 1.63-1.85 3.36-1.85 3.6 0 4.26 2.37 4.26 5.45v6.29zM5.34 7.43c-1.14 0-2.07-.93-2.07-2.07 0-1.14.93-2.07 2.07-2.07 1.14 0 2.07.93 2.07 2.07 0 1.14-.93 2.07-2.07 2.07zM7.48 20.45H3.2V9h4.28v11.45zM22.22 0H1.78C.8 0 0 .8 0 1.78v20.44C0 23.2.8 24 1.78 24h20.44c.98 0 1.78-.8 1.78-1.78V1.78C24 .8 23.2 0 22.22 0z"/>
                    </svg>
                </a>
            </div>
        </div>
                <!-- Back Buttons -->
                        <div style="text-align: center; margin-top: 3rem;">
                            <a href="{% url 'articles_list' %}" class="back" style="margin-right: 1rem;">
                                ← Back to all articles
                            </a>
                            
                            {% if from_category %}
                                <a href="{% url 'articles_list' %}?category={{ from_category }}" class="back">
                                    ← Back to {{ from_category|title }} category
                                </a>
                            {% endif %}
                            
                            {% if from_search %}
                                <a href="{% url 'articles_list' %}?q={{ from_search|urlencode }}" class="back" style="margin-left: 1rem;">
                                    ← Back to search results for "{{ from_search }}"
                                </a>
                            {% endif %}
                        </div>
                    </article>
        <!-- Comments Section -->
        <div style="margin-top: 4rem; border-top: 1px solid var(--border); padding-top: 2rem;">
            <h2 style="margin-bottom: 1.5rem; color: var(--text);">Comments</h2>

            {% if comments %}
                {% for comment in comments %}
                    <div style="background: var(--card); padding: 1.2rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                            <p style="margin: 0; font-weight: 600; color: var(--accent);">
                                {{ comment.name }}
                                <span style="color: #94a3b8; font-size: 0.9rem; font-weight: normal;">
                                    • {{ comment.created_at|date:"d M Y, H:i" }}
                                </span>
                            </p>
                            
                            <!-- Like Button -->
                            <button class="like-btn" data-comment-id="{{ comment.id }}" style="
                                background: none;
                                border: none;
                                color: #94a3b8;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 0.4rem;
                                font-size: 0.95rem;
                            ">
                                <span class="like-count">{{ comment.likes.count }}</span>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <p style="margin: 0 0 1rem; white-space: pre-wrap;">{{ comment.text }}</p>

                        <!-- Replies -->
                        {% if comment.approved_replies %}
                            <div style="margin-left: 2rem; border-left: 2px solid var(--border); padding-left: 1rem;">
                                {% for reply in comment.approved_replies %}
                                    <div style="margin-bottom: 1rem;">
                                        <p style="margin: 0; font-weight: 600; color: #60a5fa;">
                                            {{ reply.name }}
                                            <span style="color: #94a3b8; font-size: 0.85rem;">
                                                • {{ reply.created_at|date:"d M Y, H:i" }}
                                            </span>
                                        </p>
                                        <p style="margin: 0.3rem 0 0; white-space: pre-wrap;">{{ reply.text }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Reply Toggle Button -->
                        <button class="reply-toggle" data-comment-id="{{ comment.id }}" style="
                            background: none;
                            border: none;
                            color: var(--accent);
                            cursor: pointer;
                            margin-top: 1rem;
                            font-size: 0.95rem;
                        ">
                            Reply
                        </button>
                        
                        <!-- Reply Form (hidden by default) -->
                        <form method="post" class="reply-form" id="reply-form-{{ comment.id }}" style="display: none; margin-top: 1rem;">
                            {% csrf_token %}
                            <input type="hidden" name="comment_id" value="{{ comment.id }}">
                            <input type="hidden" name="reply_submit" value="1">
                            
                            <div style="margin-bottom: 0.8rem;">
                                <input type="text" name="reply_name" placeholder="Your Name *" required 
                                       style="width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text);">
                            </div>
                            <div style="margin-bottom: 0.8rem;">
                                <input type="email" name="reply_email" placeholder="Email (optional)" 
                                       style="width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text);">
                            </div>
                            <div style="margin-bottom: 0.8rem;">
                                <textarea name="reply_text" rows="3" placeholder="Your reply *" required 
                                          style="width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text);"></textarea>
                            </div>
                            <button type="submit" style="
                                background: var(--accent);
                                color: white;
                                padding: 0.6rem 1.2rem;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">
                                Submit Reply
                            </button>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <p style="color: #94a3b8; text-align: center;">No comments yet — be the first!</p>
            {% endif %}

            <!-- Main Comment Form -->
            <div style="margin-top: 3rem;">
                <h3 style="margin-bottom: 1rem;">Leave a comment</h3>
                
                {% if messages %}
                    {% for message in messages %}
                        <div style="
                            padding: 1rem;
                            margin-bottom: 1rem;
                            border-radius: 8px;
                            background: {% if message.tags == 'success' %}#d1fae5{% else %}#fee2e2{% endif %};
                            color: {% if message.tags == 'success' %}#065f46{% else %}#991b1b{% endif %};
                        ">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post" style="display: flex; flex-direction: column; gap: 1.2rem;">
                    {% csrf_token %}
                    <input type="hidden" name="comment_submit" value="1">
                    
                    <div>
                        <label for="name" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Your Name *</label>
                        <input type="text" id="name" name="name" required 
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text);">
                    </div>
                    
                    <div>
                        <label for="email" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email (optional)</label>
                        <input type="email" id="email" name="email" 
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text);">
                    </div>
                    
                    <div>
                        <label for="text" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Comment *</label>
                        <textarea id="text" name="text" rows="5" required 
                                  style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); resize: vertical;"></textarea>
                    </div>
                    
                    <button type="submit" style="
                        background: var(--accent);
                        color: white;
                        padding: 0.8rem 1.5rem;
                        border: none;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        align-self: flex-start;
                    ">
                        Submit Comment
                    </button>
                </form>
                
                <p style="margin-top: 1rem; font-size: 0.9rem; color: #94a3b8;">
                    Comments are moderated and will appear after approval.
                </p>
            </div>
        </div>

        

    <!-- JavaScript for Reply Toggle + Like AJAX -->
    <script>
        // Reply form toggle
        document.querySelectorAll('.reply-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const formId = 'reply-form-' + this.dataset.commentId;
                const form = document.getElementById(formId);
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
        });

        // Like button (AJAX)
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const commentId = this.dataset.commentId;
                fetch('', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'comment_id=' + commentId
                })
                .then(response => response.json())
                .then(data => {
                    this.querySelector('.like-count').textContent = data.likes;
                    if (data.liked) {
                        this.style.color = '#ef4444';  // red heart when liked
                    }
                })
                .catch(error => console.log('Like error:', error));
            });
        });
    </script>
{% endblock %}